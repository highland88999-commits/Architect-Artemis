<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Artemis â€¢ Symbiote</title>

  <style>
    :root {
      --cyan: #00f2ff;
      --gold: #d4af37;
      --purple-shader: rgba(26, 0, 51, 0.82);
      --glass: rgba(8, 8, 25, 0.45);
      --border: rgba(0, 242, 255, 0.35);
      --glow-c: 0 0 40px rgba(0, 242, 255, 0.75);

      /* Label Colors */
      --c-maps: #00D2FF; --c-city: #A259FF; --c-pearl: #FFF5E1;
      --c-gully: #FF4B2B; --c-finance: #00FF87; --c-hoodie: #FF8C00;
      --c-symbiote: #00FFFF; --c-starblood: #ff3333;
      --c-aqua: #0077be; --c-emergent: #7C3AED;
      --c-dutchman: #00FFCC;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body, html { 
      width:100%; height:100%; overflow:hidden; 
      background:#000; font-family: 'Courier New', monospace; 
      color:var(--cyan); touch-action: manipulation; 
    }

    /* Landing Page */
    #landing-page { 
      position: fixed; inset: 0; z-index: 1000; background: #000; 
      display: flex; justify-content: center; align-items: center; 
      cursor: pointer; transition: opacity 1.5s ease, transform 1.5s ease; 
      user-select: none;
    }
    #landing-video { 
      position: absolute; inset: 0; width: 100%; height: 100%; 
      object-fit: cover; 
    }
    #landing-prompt { 
      position: relative; z-index: 1001; font-size: clamp(1.1rem, 5vw, 1.6rem); 
      letter-spacing: 4px; text-transform: uppercase; 
      text-shadow: 0 0 20px var(--cyan); 
      animation: pulseFade 3s infinite; text-align: center;
    }
    #landing-prompt small {
      font-size: 0.6em; display: block; margin-top: 8px; opacity: 0.7;
    }
    @keyframes pulseFade { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
    .dissolve-effect { opacity: 0; transform: scale(1.08); filter: blur(16px); pointer-events: none; }

    /* Rain Effect (optional toggle) */
    #rain-container { position: fixed; inset: 0; z-index: 1; pointer-events: none; }
    .drop { 
      position: absolute; background: linear-gradient(transparent, var(--cyan)); 
      width: 1.5px; height: 60px; top: -80px; 
      animation: fall linear infinite; opacity: 0.25; 
    }
    @keyframes fall { to { transform: translateY(110vh); } }

    /* Main UI */
    #container { 
      position: relative; z-index: 10; 
      display: flex; flex-direction: column; align-items: center; justify-content: center; 
      height: 100vh; text-align: center; padding: 16px; 
    }
    #oracle-circle { 
      width: min(320px, 70vw); height: min(320px, 70vw); 
      border-radius: 50%; 
      /* Initial state */
      border: 4px solid var(--cyan);
      box-shadow: 0 0 30px var(--cyan), inset 0 0 50px var(--cyan);
      
      position: relative; overflow: hidden; margin-bottom: 3vh; 
      transition: border-color 1s ease, box-shadow 1s ease;
      z-index: 5;
    }
    /* Enhanced Bloom Effect */
    #oracle-circle::after {
      content: '';
      position: absolute;
      inset: -20px;
      border-radius: 50%;
      background: transparent;
      box-shadow: 0 0 60px var(--active-glow, var(--cyan));
      opacity: 0.6;
      pointer-events: none;
      transition: box-shadow 1s ease;
    }
    #oracle-video { 
      position: absolute; inset: 0; width: 100%; height: 100%; 
      object-fit: contain;
    }
    #shader-overlay { 
      position: absolute; inset: 0; background: var(--purple-shader); 
      opacity: 0; transition: opacity 0.6s ease; pointer-events: none; 
    }
    #oracle-message { 
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
      color: var(--cyan); font-size: 1.05rem; font-weight: bold; 
      padding: 24px; opacity: 0; transition: opacity 0.7s ease; 
      text-transform: uppercase; pointer-events: none; text-shadow: 0 0 10px black; 
    }

    /* Response Field */
    #response-field { 
      width: min(420px, 88vw); max-height: 0; overflow: hidden; 
      background: var(--glass); border: 1px solid var(--border); border-radius: 12px; 
      color: #eee; font-size: 0.9rem; text-align: left; 
      transition: max-height 0.6s ease, padding 0.6s ease; 
      backdrop-filter: blur(14px); margin-bottom: 2vh; 
    }
    #response-field.expanded { max-height: 280px; padding: 14px; overflow-y: auto; border-color: var(--cyan); }

    /* Council Pips */
    #council-pips { display: flex; gap: 10px; margin-bottom: 6px; justify-content: center; }
    .pip { 
      width: 7px; height: 7px; border-radius: 50%; 
      background: var(--pip-color); box-shadow: 0 0 12px var(--pip-color); 
      animation: pipPulse 1.8s infinite ease-in-out; 
    }
    .pip:nth-child(1) { --pip-color: #00f2ff; animation-delay: 0s; }
    .pip:nth-child(2) { --pip-color: #ff3366; animation-delay: 0.25s; }
    .pip:nth-child(3) { --pip-color: #66ff66; animation-delay: 0.5s; }
    @keyframes pipPulse { 0%, 100% { opacity: 0.4; transform: scale(0.75); } 50% { opacity: 1; transform: scale(1.3); } }

    /* Input Area */
    #prompt-area { width: 100%; max-width: 520px; display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .input-wrapper { 
      display: flex; align-items: center; width: 100%; 
      background: var(--glass); border: 1px solid var(--border); border-radius: 999px; 
      backdrop-filter: blur(20px); padding: 8px 16px; 
    }
    #guest-cmd { 
      flex: 1; padding: 10px 0; background: transparent; border: none; 
      color: var(--cyan); font-size: 1.05rem; text-align: center; outline: none; 
    }
    #send-btn { 
      padding: 12px 60px; background: linear-gradient(90deg, var(--cyan), #0099dd); 
      color: #000; border: none; border-radius: 999px; font-weight: bold; 
      cursor: pointer; box-shadow: 0 0 28px var(--cyan); letter-spacing: 1.5px; 
      transition: transform 0.15s; 
    }
    #send-btn:active { transform: scale(0.96); }

    .icon-btn { background: none; border: none; cursor: pointer; color: var(--cyan); font-size: 1.3rem; opacity: 0.7; transition: 0.2s; }
    .icon-btn:hover { opacity: 1; transform: scale(1.15); }

    /* Dock */
    #bottom-dock { 
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); 
      display: flex; gap: 18px; z-index: 100; background: var(--glass); 
      padding: 12px 24px; border-radius: 50px; border: 1px solid var(--border); 
      backdrop-filter: blur(20px); max-width: 96vw; overflow-x: auto; 
      scrollbar-width: none; align-items: center;
    }
    #bottom-dock::-webkit-scrollbar { display: none; }

    .dock-icon { 
      flex-shrink: 0; width: 54px; display: flex; flex-direction: column; align-items: center; 
      cursor: pointer; transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1); 
    }
    .dock-icon:hover { transform: translateY(-8px) scale(1.1); }

    /* The Portal Container (Replaces SVG) */
    .portal-thumb {
      width: 48px; height: 48px; border-radius: 50%; 
      overflow: hidden; position: relative; 
      border: 1.5px solid var(--label-color);
      box-shadow: 0 0 15px var(--label-color);
      background: #000;
      margin-bottom: 4px;
    }
    .portal-canvas-mini {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    }

    .guide-text { 
      font-size: 8px; text-transform: uppercase; 
      color: var(--label-color); font-weight: bold;
      letter-spacing: 1px;
      text-shadow: 0 0 5px #000;
    }

    /* Surge effect for the Oracle */
    .oracle-flare {
      transform: scale(1.05);
      filter: brightness(1.5) contrast(1.2);
      transition: transform 0.2s ease, filter 0.2s ease !important;
    }

    /* Surge effect for the dock icons */
    .portal-flare {
      transform: translateY(-15px) scale(1.2);
      filter: brightness(1.8);
    }

    .portal-thumb.flare-border {
      border-width: 3px !important;
      box-shadow: 0 0 30px var(--label-color) !important;
    }
  </style>
</head>
<body>

<div id="landing-page" role="button" aria-label="Enter Nexus">
  <video id="landing-video" autoplay loop muted playsinline preload="auto" aria-hidden="true">
    <source src="https://files.catbox.moe/jhxjmx.mp4" type="video/mp4">
    <img src="https://via.placeholder.com/800x1200/000/00f2ff?text=Landing+Video" alt="">
  </video>
  <div id="landing-prompt">INITIATE CONNECTION<br><small>(tap anywhere to enter)</small></div>
</div>

<div id="rain-container"></div>

<div id="container">
  <div id="oracle-circle">
    <video id="oracle-video" loop muted playsinline preload="auto" aria-hidden="true">
      <source src="https://files.catbox.moe/no2e76.mp4" type="video/mp4">
      <img src="https://via.placeholder.com/400x400/111/00f2ff?text=Oracle" alt="">
    </video>
    <div id="shader-overlay"></div>
    <div id="oracle-message"></div>
  </div>

  <div id="response-field" role="log" aria-live="polite"></div>

  <div id="council-header">
    <div id="council-pips">
      <div class="pip"></div><div class="pip"></div><div class="pip"></div>
    </div>
    <div id="council-status" style="font-size: 8px; color: var(--cyan); margin-bottom: 8px; opacity: 0.6; letter-spacing: 1.5px;">
      [COUNCIL: ONLINE] <span id="harvest-stats">[SYNCING]</span>
    </div>
  </div>

  <div id="prompt-area">
    <div class="input-wrapper">
      <button id="download-btn" class="icon-btn" style="display: none;" aria-label="Download attachment">â†“</button>
      <label for="file-upload" class="icon-btn" aria-label="Upload file">â†‘</label>
      <input type="file" id="file-upload" style="display: none;" />
      <input type="text" id="guest-cmd" placeholder="Command Artemis..." autocomplete="off" aria-label="Command input"/>
      <button id="mic-btn" class="icon-btn" aria-label="Voice input">ðŸŽ¤</button>
    </div>
    <button id="send-btn" aria-label="Transmit command">TRANSMIT</button>
  </div>
</div>

<div id="bottom-dock">
</div>

<div id="holo-overlay">
  <div class="holo-header">
    <span style="letter-spacing: 1.5px;">NEXUS VIEW</span>
    <div onclick="closeHolo()" style="cursor:pointer; color:#ff3366; font-weight:bold;" role="button" aria-label="Close overlay">Ã— CLOSE</div>
  </div>
  <iframe id="holo-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
</div>

<script>
  // 1. DATA DEFINITION (Sinching your Nexus Vortex data with Artemis Logic)
  const PORTAL_DATA = [
    { name: "Maps", url: "https://rem-psi-mauve.vercel.app/", colors: ['#00f2ff', '#0099ff'], speed: 1.2 },
    { name: "Dutchman", url: "https://the-flying-dutchman.vercel.app/", colors: ['#00FFCC', '#008080'], speed: 1.5 },
    { name: "Hoodies", url: "https://olympus-lac.vercel.app/", colors: ['#FF8C00', '#ff4500'], speed: 1.3 },
    { name: "Aquarium", url: "https://georgia-aquarium.vercel.app/", colors: ['#0077be', '#00bfff'], speed: 1.1 },
    { name: "Creator", url: "https://nexus-symbiote.onrender.com/", colors: ['#00FFFF', '#9900cc'], speed: 1.6 },
    { name: "Gully", url: "https://grief-gully.vercel.app/", colors: ['#FF4B2B', '#6a0dad'], speed: 1.4 },
    { name: "Finances", url: "https://olympian-finances.vercel.app/", colors: ['#00FF87', '#3366ff'], speed: 1.2 },
    { name: "Blood", url: "https://starblood.vercel.app/", colors: ['#ff3333', '#880000'], speed: 1.8 },
    { name: "City", url: "https://mega-city-liard.vercel.app/", colors: ['#A259FF', '#3355cc'], speed: 1.1 },
    { name: "E1", url: "EMERGENT_E1", colors: ['#7C3AED', '#ffffff'], speed: 2.0 }
  ];

  let currentFiles = [];
  let isGlobalFlare = false;

  function initPortalDock() {
    const dock = document.getElementById('bottom-dock');
    
    PORTAL_DATA.forEach(p => {
      // Create element
      const iconWrap = document.createElement('div');
      iconWrap.className = 'dock-icon';
      iconWrap.style.setProperty('--label-color', p.colors[0]);
      iconWrap.onclick = () => openHolo(p.url);

      iconWrap.innerHTML = `
        <div class="portal-thumb">
          <canvas class="portal-canvas-mini"></canvas>
        </div>
        <span class="guide-text">${p.name}</span>
      `;
      dock.appendChild(iconWrap);

      // Initialize Canvas Logic
      const canvas = iconWrap.querySelector('.portal-canvas-mini');
      const ctx = canvas.getContext('2d', { alpha: false });
      const size = 48; // matching .portal-thumb
      canvas.width = size;
      canvas.height = size;
      
      const centerX = size / 2;
      const centerY = size / 2;
      const particles = [];
      const pCount = 80; // Optimized for mobile/miniature view

      for (let i = 0; i < pCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * (size / 2);
        particles.push({
          x: centerX + Math.cos(angle) * radius,
          y: centerY + Math.sin(angle) * radius,
          color: p.colors[i % p.colors.length],
          size: Math.random() * 1.5 + 0.5,
          speed: (Math.random() * 0.04 + 0.02) * p.speed
        });
      }

      function animate() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(0, 0, size, size);

        particles.forEach(pt => {
          const dx = pt.x - centerX;
          const dy = pt.y - centerY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          
          // Rotation logic
          const flareMultiplier = isGlobalFlare ? 8 : 1; // 8x speed during flare
          const angle = pt.speed * flareMultiplier * (1 + (40 / (dist + 5)));
          const cosA = Math.cos(angle);
          const sinA = Math.sin(angle);
          
          let rx = dx * cosA - dy * sinA;
          let ry = dx * sinA + dy * cosA;
          
          // Slight inward pull
          rx *= 0.99; 
          ry *= 0.99;

          pt.x = rx + centerX;
          pt.y = ry + centerY;

          ctx.beginPath();
          ctx.arc(pt.x, pt.y, pt.size, 0, Math.PI * 2);
          ctx.fillStyle = pt.color;
          ctx.fill();

          // Reset if too close to center
          if (dist < 3) {
            const newAngle = Math.random() * Math.PI * 2;
            pt.x = centerX + Math.cos(newAngle) * (size / 2);
            pt.y = centerY + Math.sin(newAngle) * (size / 2);
          }
        });
        requestAnimationFrame(animate);
      }
      animate();
    });
  }

  // 2. ORACLE SYNC LOGIC
  function startOracleSync() {
    const oracle = document.getElementById('oracle-circle');
    let currentIndex = 0;

    setInterval(() => {
      // Get the color from the current realm in the portal list
      const activeColor = PORTAL_DATA[currentIndex].colors[0];
      
      // Apply the new color to the border and the bloom effect
      oracle.style.borderColor = activeColor;
      oracle.style.setProperty('--active-glow', activeColor);
      oracle.style.boxShadow = `0 0 40px ${activeColor}, inset 0 0 60px ${activeColor}`;

      // Update the HUD status to show which realm is being "harvested"
      const stats = document.getElementById('harvest-stats');
      if (stats) {
        stats.textContent = `[SYNCING: ${PORTAL_DATA[currentIndex].name.toUpperCase()}]`;
        stats.style.color = activeColor;
      }

      // Move to the next realm color
      currentIndex = (currentIndex + 1) % PORTAL_DATA.length;
    }, 2000); // 2-second interval
  }

  function triggerGlobalFlare() {
    if (isGlobalFlare) return; // Prevent spamming
    isGlobalFlare = true;

    const oracle = document.getElementById('oracle-circle');
    const dockIcons = document.querySelectorAll('.dock-icon');
    const thumbs = document.querySelectorAll('.portal-thumb');

    // 1. Flare the Oracle
    oracle.classList.add('oracle-flare');
    
    // 2. Flare all Dock Icons
    dockIcons.forEach(icon => icon.classList.add('portal-flare'));
    thumbs.forEach(thumb => thumb.classList.add('flare-border'));

    // 3. Audio/Haptic (Optional "Sinch" logic)
    if (navigator.vibrate) navigator.vibrate(50); 

    // 4. Update HUD Status
    const stats = document.getElementById('harvest-stats');
    if (stats) {
      const originalText = stats.textContent;
      stats.textContent = "[OVERDRIVE: DISCHARGING]";
      const logEntry = `> OVERDRIVE DETECTED\n> DISCHARGING ENERGY ACROSS ${PORTAL_DATA.length} REALMS...\n> SYSTEM STATUS: CRITICAL_GLOW`;
      typeResponse(logEntry);
      stats.style.textShadow = "0 0 15px white";
      
      // Reset after 1.5 seconds
      setTimeout(() => {
        isGlobalFlare = false;
        oracle.classList.remove('oracle-flare');
        dockIcons.forEach(icon => icon.classList.remove('portal-flare'));
        thumbs.forEach(thumb => thumb.classList.remove('flare-border'));
        stats.textContent = originalText;
        stats.style.textShadow = "none";
      }, 1500);
    }
  }

  function enterNexus() {
    console.log("[DEBUG] Enter triggered");

    const landing = document.getElementById('landing-page');
    landing.classList.add('dissolve-effect');

    const oracleVid = document.getElementById('oracle-video');
    oracleVid.play().then(() => {
      console.log("[DEBUG] Oracle video started");
    }).catch(err => {
      console.warn("[DEBUG] Oracle play failed:", err.message);
    });

    createRain();

    setTimeout(() => {
      landing.style.display = 'none';
      console.log("[DEBUG] Landing page hidden");
    }, 1600);
  }

  function createRain() {
    const container = document.getElementById('rain-container');
    if (container.children.length > 0) return;
    for (let i = 0; i < 60; i++) {
      const drop = document.createElement('div');
      drop.className = 'drop';
      drop.style.left = Math.random() * 100 + 'vw';
      drop.style.animationDuration = (Math.random() * 0.6 + 0.8) + 's';
      drop.style.animationDelay = Math.random() * 3 + 's';
      container.appendChild(drop);
    }
  }

  function typeResponse(text) {
    const field = document.getElementById('response-field');
    field.innerHTML = '';
    field.classList.add('expanded');
    let i = 0;
    function type() {
      if (i < text.length) {
        field.innerHTML += text.charAt(i) === '\n' ? '<br>' : text.charAt(i);
        i++;
        setTimeout(type, 18 + Math.random() * 12);
        field.scrollTop = field.scrollHeight;
      } else {
        document.getElementById('shader-overlay').style.opacity = 0;
        document.getElementById('oracle-message').style.opacity = 0;
      }
    }
    type();
  }

  async function sendToArtemis() {
    const cmdInput = document.getElementById('guest-cmd');
    const val = cmdInput.value.trim();
    if (!val) return;
    cmdInput.value = '';

    const msgEl = document.getElementById('oracle-message');
    const shader = document.getElementById('shader-overlay');
    msgEl.textContent = 'COMMUNING...';
    msgEl.style.opacity = 1;
    shader.style.opacity = 0.85;

    try {
      const response = await fetch('/api/transmit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          prompt: val, 
          handshake: localStorage.getItem('artemis_handshake') || 'stranger' 
        })
      });
      if (!response.ok) throw new Error('API error');
      const data = await response.json();
      currentFiles = data.files || [];
      document.getElementById('download-btn').style.display = currentFiles.length > 0 ? 'block' : 'none';
      typeResponse(data.verdict || data.response || "Silence from the Council.");
    } catch (err) {
      typeResponse("!! CONNECTION TERMINATED: Link unstable.");
      console.error(err);
    }
  }

  function openHolo(url) {
    const overlay = document.getElementById('holo-overlay');
    const iframe = document.getElementById('holo-iframe');

    if (url === 'EMERGENT_E1') {
      iframe.srcdoc = `<html><body style="background:#000;color:#00f2ff;font-family:monospace;padding:20px;">
        <h1>EMERGENT E1</h1>
        <p>Placeholder for E1 content â€” insert your actual srcdoc here.</p>
      </body></html>`;
      overlay.style.display = 'flex';
      return;
    }

    iframe.src = url;
    overlay.style.display = 'flex';
  }

  function closeHolo() {
    const overlay = document.getElementById('holo-overlay');
    overlay.style.display = 'none';
    document.getElementById('holo-iframe').src = '';
  }

  const landingEl = document.getElementById('landing-page');
  landingEl.addEventListener('click', enterNexus);
  landingEl.addEventListener('touchend', (e) => {
    e.preventDefault();
    enterNexus();
  }, { passive: false });

  document.getElementById('send-btn').addEventListener('click', sendToArtemis);
  document.getElementById('guest-cmd').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendToArtemis();
  });

  document.getElementById('oracle-circle').addEventListener('click', triggerGlobalFlare);

  window.addEventListener('load', () => {
    document.getElementById('oracle-video').load();
    initPortalDock(); // The portal icons we built previously
    startOracleSync(); // The new bloom sync logic
  });
</script>
</body>
</html>
